name: Fix Release

on:
  workflow_dispatch:
    inputs:
      release_version:
        description: 'Release version'
        required: true
env:
  REGISTRY: cr.yandex/${{ secrets.YC_REGISTRY_ID }}
  IMAGE_NAME: app
  IP_ADDRESS: 51.250.35.196
  VM_USERNAME: muhozhuk
  FIX_RELEASE_VERSION: ${{ github.event.inputs.release_version }}_fix${{ github.run_number }}

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        job: [lint, test]
    name: Run ${{ matrix.job }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Use Node.js 20.x
        
        uses: actions/setup-node@v3
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run test
        if: matrix.job == 'test'
        run: npm run test

      - name: Run lint
        if: matrix.job == 'lint'
        run: npm run lint

  fix-release:
    needs: lint-and-test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1
      
      # - name: Set up SSH
      #   uses: webfactory/ssh-agent@v0.5.3
      #   with:
      #     ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      
      # - name: Add server to known_hosts
      #   run: |
      #     ssh-keyscan ${{ env.IP_ADDRESS }} >> ~/.ssh/known_hosts
      
      - name: Log in to Yandex Container Registry
        run: echo ${{ secrets.YCR_TOKEN }} | docker login --username oauth --password-stdin cr.yandex
      
      - name: Switch to release branch
        run: |
          git checkout -b releases/${{ github.event.inputs.release_version }}

      # - name: Increment fix release number
      #   id: fix-release
      #   run: echo "::set-output name=fix_number::$((${{ github.run_number }}))" >> $GITHUB_ENV

      - name: Build and tag Docker image
        # env:
        #   FIX_RELEASE_VERSION: ${{ github.event.inputs.release_version }}_fix${{ steps.fix-release.outputs.fix_number }}
        run: |
          docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.FIX_RELEASE_VERSION }} .
          docker tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.FIX_RELEASE_VERSION }} ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.event.inputs.release_version }}_latest

      - name: Push Docker image to registry
        run: |
          FIX_RELEASE_VERSION=${{ github.event.inputs.release_version }}_fix${{ env.fix_number }}
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.FIX_RELEASE_VERSION }}
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.event.inputs.release_version }}_latest
      
      - name: Create a fix release tag
        run: |
          git tag ${{ env.FIX_RELEASE_VERSION }}
          git push origin ${{ env.FIX_RELEASE_VERSION }}

      # - name: Create fix release tag
      #   run: |
      #     git tag -a ${GITHUB_REF#refs/heads/}-fix${{ steps.fix-release.outputs.fix_number }} -m "Fix release ${{ github.event.inputs.release_version }} fix${{ steps.fix-release.outputs.fix_number }}"
      #     git push origin ${GITHUB_REF#refs/heads/}-fix${{ steps.fix-release.outputs.fix_number }}

      - name: Add comment to the appropriate GitHub Issue
        uses: actions/github-script@v3
        with:
          script: |
            const releaseVersion = context.payload.inputs.release_version;
            const fixNumber = context.run_number;
            const { data: issues } = await github.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open'
            });

            const releaseIssue = issues.find(issue => issue.title.includes(`Release ${releaseVersion}`));

            if (!releaseIssue) {
              throw new Error(`Issue for release version ${releaseVersion} not found`);
            }

            const { data: commits } = await github.repos.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: `releases/${releaseVersion}`
            });

            const commitMessages = commits.map(commit => `- ${commit.commit.message}`).join('\n');

            const comment = `Fix release ${releaseVersion} fix${fixNumber} has been deployed on ${new Date().toISOString()} by ${context.actor}.\n\nCommits:\n${commitMessages}\n\nDocker Image: cr.yandex/${{ secrets.YCR_REGISTRY_ID }}/${{ env.IMAGE_NAME }}:${{ env.FIX_RELEASE_VERSION }}`;

            await github.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: releaseIssue.number,
              body: comment
            });